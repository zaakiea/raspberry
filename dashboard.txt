import serial
import time
import psutil
import requests
from datetime import datetime

# --- SETTING LOKASI (Kec. Bukateja, Purbalingga) ---
LAT = -7.4287
LON = 109.4336
NAMA_KOTA = "Bukateja" # Singkat agar muat di layar

# --- KONEKSI ARDUINO ---
# Coba /dev/ttyACM0 dulu, kalau gagal script akan coba ttyUSB0
PORT = '/dev/ttyACM0' 

def connect_arduino():
    try:
        return serial.Serial(PORT, 9600, timeout=1)
    except:
        try:
            return serial.Serial('/dev/ttyUSB0', 9600, timeout=1)
        except:
            return None

def get_cuaca():
    try:
        # Mengambil data dari Open-Meteo (Gratis)
        url = f"https://api.open-meteo.com/v1/forecast?latitude={LAT}&longitude={LON}&current_weather=true&timezone=auto"
        r = requests.get(url, timeout=5)
        data = r.json()
        
        temp = data['current_weather']['temperature']
        code = data['current_weather']['weathercode']
        
        # Terjemahkan kode cuaca
        status = "Cerah"
        if code > 3: status = "Mendung"
        if code > 50: status = "Hujan"
        if code > 80: status = "Badai"
        
        return f"{temp}C {status}"
    except:
        return "Offline"

# --- PROGRAM UTAMA ---
print("Memulai Dashboard Bukateja...")
ser = connect_arduino()

if not ser:
    print("Error: Arduino tidak terdeteksi! Cek Kabel USB.")
    exit()

time.sleep(2) # Tunggu Arduino siap

while True:
    try:
        # === SLIDE 1: STATUS KOMPUTER (Tampil 5 Detik) ===
        cpu = int(psutil.cpu_percent(interval=None))
        ram = int(psutil.virtual_memory().percent)
        
        # Jika CPU > 80%, Lampu jadi Merah (Kode 1), jika tidak Hijau (Kode 0)
        warn = 1 if cpu > 80 else 0
        
        # Kirim: WARNA|BARIS1|BARIS2
        msg1 = f"{warn}|CPU: {cpu}%  RAM: {ram}%|System Monitor"
        ser.write((msg1 + "\n").encode('utf-8'))
        
        time.sleep(5)
        
        # === SLIDE 2: INFO BUKATEJA (Tampil 5 Detik) ===
        now = datetime.now()
        jam = now.strftime("%H:%M")
        tgl = now.strftime("%d/%m")
        cuaca = get_cuaca()
        
        # Format Layar:
        # Baris 1: 14:00 WIB 14/01
        # Baris 2: Bukateja: 28C Hujan
        msg2 = f"0|{jam} WIB  {tgl}|{NAMA_KOTA}: {cuaca}"
        ser.write((msg2 + "\n").encode('utf-8'))
        
        time.sleep(5)

    except KeyboardInterrupt:
        print("Stop.")
        break
    except Exception as e:
        print(f"Error: {e}")
        # Coba reconnect jika putus
        ser = connect_arduino()
