import serial
import time
import psutil
import requests
from datetime import datetime

# --- KONFIGURASI ---
SERIAL_PORT = '/dev/ttyACM0'  # Cek lagi port Arduino Anda
BAUD_RATE = 9600


LATITUDE = -7.4287
LONGITUDE = 109.4336
CITY_NAME = "Bukateja"

def get_weather():
    try:
        # Menggunakan API Open-Meteo (Gratis, No Key)
        url = f"https://api.open-meteo.com/v1/forecast?latitude={LATITUDE}&longitude={LONGITUDE}&current_weather=true&timezone=auto"
        response = requests.get(url, timeout=5)
        data = response.json()
        
        temp = data['current_weather']['temperature']
        code = data['current_weather']['weathercode']
        
        # Terjemahkan kode cuaca sederhana
        condition = "Cerah"
        if code > 3: condition = "Mendung" # Ganti "Berawan" jadi "Mendung" (lebih pendek)
        if code > 50: condition = "Hujan"
        if code > 90: condition = "Badai"
        
        return f"{temp}C {condition}"
    except:
        return "Offline"

# Setup Serial
try:
    ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=1)
    ser.flush()
    print("Terhubung ke Arduino...")
except:
    print("Gagal koneksi Serial! Cek kabel.")
    exit()

print("Dashboard berjalan... Tekan Ctrl+C untuk stop.")

while True:
    try:
        # --- MODE 1: INFO PC (Tampil selama 5 detik) ---
        cpu = int(psutil.cpu_percent(interval=None))
        ram = int(psutil.virtual_memory().percent)
        
        # Tentukan Warna LED (0=Hijau, 1=Merah jika CPU > 80%)
        led_status = 1 if cpu > 80 else 0
        
        # Format: STATUS|BARIS1|BARIS2
        msg_pc = f"{led_status}|CPU: {cpu}% RAM: {ram}%|System Healthy"
        ser.write((msg_pc + "\n").encode('utf-8'))
        
        time.sleep(5) # Tahan tampilan ini 5 detik
        
        # --- MODE 2: INFO INTERNET (Tampil selama 5 detik) ---
        # Ambil Waktu
        now = datetime.now()
        current_time = now.strftime("%H:%M") # Format Jam:Menit
        date_str = now.strftime("%d/%m")     # Format Tgl/Bln
        
        # Ambil Cuaca
        weather_info = get_weather()
        
        # Format pesan
        # Baris 1: Jam dan Tanggal
        # Baris 2: Nama Kota dan Cuaca
        msg_web = f"0|{current_time} WIB  {date_str}|{CITY_NAME}: {weather_info}"
        ser.write((msg_web + "\n").encode('utf-8'))
        
        time.sleep(5) # Tahan tampilan ini 5 detik
        
    except KeyboardInterrupt:
        print("Selesai.")
        break
    except Exception as e:
        print(f"Error: {e}")
        time.sleep(2)

